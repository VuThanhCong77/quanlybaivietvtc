/**
 * =====================================================
 * SCRIPT SINH FILE CHIA S·∫∫ FACEBOOK T·ª∞ ƒê·ªòNG (OPEN GRAPH)
 * S·ª≠ d·ª•ng n·ªôi b·ªô ‚Äì Chu·∫©n h√≥a tri·ªÉn khai th·ª±c t·∫ø
 * =====================================================
 */

const fs = require("fs");
const path = require("path");

// ====== C·∫§U H√åNH CHUNG ======
const BASE_URL = "https://vuthanhcong77.github.io/quanlybaivietvtc/";
const POSTS_FILE = "posts_data.json";
const SHARE_DIR = "share";
const DEFAULT_IMAGE = BASE_URL + "images/default.jpg";

// ====== T·∫†O TH∆Ø M·ª§C SHARE ======
if (!fs.existsSync(SHARE_DIR)) {
    fs.mkdirSync(SHARE_DIR, { recursive: true });
}

// ====== ƒê·ªåC D·ªÆ LI·ªÜU B√ÄI VI·∫æT ======
let posts = [];
try {
    posts = JSON.parse(fs.readFileSync(POSTS_FILE, "utf8"));
} catch (err) {
    console.error("‚ùå L·ªói ƒë·ªçc posts_data.json:", err.message);
    process.exit(1);
}

// ====== H√ÄM ESCAPE HTML ======
function escapeHtml(text) {
    return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
}

// ====== SINH FILE SHARE ======
posts.forEach(post => {
    if (!post.id) return;

    const title = post.title || "B√†i vi·∫øt";
    const description =
        post.shortDescription ||
        post.description ||
        post.title ||
        "B√†i vi·∫øt tr√™n h·ªá th·ªëng qu·∫£n l√Ω n·ªôi dung";

    // X·ª≠ l√Ω ·∫£nh ƒë·∫°i di·ªán
    let image = DEFAULT_IMAGE;
    if (post.thumbnail && !post.thumbnail.startsWith("data:")) {
        image = BASE_URL + post.thumbnail.replace(/^\//, "");
    }

    const shareUrl = `${BASE_URL}share/share-${post.id}.html`;
    const redirectUrl = `../post.html?id=${post.id}`;

    const shareHtml = `<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)}</title>

<!-- ===== OPEN GRAPH / FACEBOOK ===== -->
<meta property="og:title" content="${escapeHtml(title)}">
<meta property="og:description" content="${escapeHtml(description)}">
<meta property="og:image" content="${image}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="${shareUrl}">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Qu·∫£n l√Ω b√†i vi·∫øt VTC">

<!-- ===== REDIRECT ===== -->
<meta http-equiv="refresh" content="0; url=${redirectUrl}">
</head>

<body>
<p>ƒêang chuy·ªÉn h∆∞·ªõng t·ªõi b√†i vi·∫øt‚Ä¶</p>
<p>
    <a href="${redirectUrl}">Nh·∫•n v√†o ƒë√¢y n·∫øu tr√¨nh duy·ªát kh√¥ng t·ª± chuy·ªÉn</a>
</p>
</body>
</html>`;

    const filePath = path.join(SHARE_DIR, `share-${post.id}.html`);
    fs.writeFileSync(filePath, shareHtml, "utf8");

    console.log(`‚úî ƒê√£ t·∫°o file chia s·∫ª: ${filePath}`);
});

console.log("üéØ HO√ÄN TH√ÄNH: Sinh file chia s·∫ª Facebook th√†nh c√¥ng.");
