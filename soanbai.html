<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title id="pageTitle">So·∫°n th·∫£o b√†i vi·∫øt</title>
<style>
/* ... (Gi·ªØ nguy√™n to√†n b·ªô CSS c·ªßa soanbai.html) ... */
body {font-family: Arial; max-width: 900px; margin: auto; padding: 20px;}
h1 {color: #0a7f99;}
label {display: block; font-weight: bold; margin-top: 15px;}
select, input[type="text"] {width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; box-sizing: border-box; border-radius: 4px;}
#toolbar {margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 4px;}
#toolbar button, #toolbar select {padding: 5px 10px; margin: 3px; cursor: pointer; border: 1px solid #aaa; background: #fff; border-radius: 3px;}
#content-area {border: 1px solid #ccc; padding: 10px; min-height: 300px; margin-top: 5px; background: #fff; line-height: 1.6; text-align: justify; /* CƒÉn ƒë·ªÅu n·ªôi dung */ max-height: 500px; overflow-y: auto;}
button {padding: 10px 15px; margin-top: 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: background 0.3s;}
button:nth-of-type(1) {background: #2ecc71; color: white;} /* N√∫t L∆∞u */
button:nth-of-type(2) {background: #3498db; color: white;} /* N√∫t Xem DS */
#delete-list {margin-top: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #fff;}
#delete-list h2 {color: #0a3a5a; margin-top: 0;}
.post-item {display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee;}
.post-item:last-child {border-bottom: none;}
.post-item button {margin: 0 5px; padding: 5px 10px; font-weight: normal;}
.edit-btn {background: #f39c12; color: white;}
.delete-btn {background: #e74c3c; color: white;}
.file-upload-section {margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 4px; background: #f9f9f9;}
#backup-restore-section {margin-top: 30px; padding: 20px; border: 2px solid #0a7f99; border-radius: 8px; background: #e7f5fa;}
.backup-btn {background: #9b59b6 !important; color: white;}
.restore-btn {background: #34495e !important; color: white;}
</style>
<script>
// --- ADMIN ACCESS CONTROL ---
const ADMIN_PASSWORD = "Cong@khuyen!7785"; // M·∫≠t kh·∫©u qu·∫£n tr·ªã
const HOMEPAGE_URL = "index.html"; // Th·ªëng nh·∫•t trang ch·ªß

function checkAdmin() {
    return sessionStorage.getItem('isAdmin') === 'true';
}

function setAdminSession() {
    const password = prompt("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã:");
    if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('isAdmin', 'true');
        return true;
    } else if (password !== null) {
        alert("M·∫≠t kh·∫©u sai.");
    }
    return false;
}
// --- END ADMIN ACCESS CONTROL ---

// KI·ªÇM TRA QUY·ªÄN TRUY C·∫¨P TRANG SO·∫†N TH·∫¢O
if (!checkAdmin()) {
    alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang so·∫°n th·∫£o.");
    if (setAdminSession()) {
        // ƒêƒÉng nh·∫≠p th√†nh c√¥ng, t·∫£i l·∫°i trang ƒë·ªÉ t·∫£i d·ªØ li·ªáu ch·ªânh s·ª≠a (n·∫øu c√≥)
        location.reload(); 
    } else {
        // ƒêƒÉng nh·∫≠p th·∫•t b·∫°i ho·∫∑c h·ªßy b·ªè
        location.href=HOMEPAGE_URL;
    }
}

// L·∫•y ID b√†i vi·∫øt t·ª´ URL n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
const urlParams = new URLSearchParams(location.search);
const postIdToEdit = urlParams.get('id');

// =================================================================
// === C√ÅC H√ÄM ƒê·ªäNH D·∫†NG (GI·ªÆ NGUY√äN) ===
// =================================================================
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('content-area').focus();
}

function insertTable() {
    // H·ªèi ng∆∞·ªùi d√πng s·ªë h√†ng v√† s·ªë c·ªôt
    const rows = prompt("Nh·∫≠p s·ªë h√†ng:", 3);
    const cols = prompt("Nh·∫≠p s·ªë c·ªôt:", 3);
    
    if (rows && cols) {
        let tableHtml = '<table border="1" style="width:100%; border-collapse: collapse; margin: 10px 0;"><tbody>';
        for (let i = 0; i < parseInt(rows); i++) {
            tableHtml += '<tr>';
            for (let j = 0; j < parseInt(cols); j++) {
                tableHtml += `<td style="padding: 8px; border: 1px solid #ccc;">√î ${i + 1}-${j + 1}</td>`;
            }
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        document.execCommand('insertHTML', false, tableHtml);
    }
}

function insertImage() {
    const fileInput = document.getElementById('contentImageFile');
    fileInput.click();
    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                // Ch√®n ·∫£nh v√†o contenteditable area
                document.execCommand('insertHTML', false, `<img src="${event.target.result}" style="max-width:100%; height:auto; display: block; margin: 10px auto;" alt="H√¨nh ·∫£nh b√†i vi·∫øt">`);
            };
            reader.readAsDataURL(file);
        }
    };
}

function insertLink() {
    const url = prompt("Nh·∫≠p URL:");
    if (url) {
        document.execCommand('createLink', false, url);
    }
}

function indentParagraph() {
    // Th√™m style cho l√πi ƒë·∫ßu d√≤ng 1cm
    const styleHtml = '<style data-custom-indent>#content-area p { text-indent: 1cm; text-align: justify; }</style>';
    const contentArea = document.getElementById('content-area');
    
    // Ki·ªÉm tra xem style ƒë√£ t·ªìn t·∫°i ch∆∞a
    if (!document.querySelector('style[data-custom-indent]')) {
        document.head.insertAdjacentHTML('beforeend', styleHtml);
    }
    
    // √Åp d·ª•ng ƒë·ªãnh d·∫°ng cho ƒëo·∫°n vƒÉn hi·ªán t·∫°i (n·∫øu c·∫ßn)
    document.execCommand('outdent', false, null); // X√≥a l√πi ƒë·∫ßu d√≤ng h·ªá th·ªëng
    document.execCommand('indent', false, null); // √Åp d·ª•ng l√πi ƒë·∫ßu d√≤ng h·ªá th·ªëng
}


// =================================================================
// === LOGIC L∆ØU V√Ä T·∫¢I D·ªÆ LI·ªÜU (LOCALSTORAGE) ===
// =================================================================

/**
 * H√†m ƒë·ªçc file v√† chuy·ªÉn th√†nh Base64
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

/**
 * L∆∞u b√†i vi·∫øt v√†o LocalStorage
 */
async function savePost() {
    const title = document.getElementById('title').value;
    const shortDescription = document.getElementById('shortDescription').value;
    const category = document.getElementById('category').value;
    const content = document.getElementById('content-area').innerHTML;
    const imageFile = document.getElementById('image').files[0];
    const documentFile = document.getElementById('documentFile').files[0];

    if (!title || !content || !category) {
        alert("Vui l√≤ng ƒëi·ªÅn Ti√™u ƒë·ªÅ, N·ªôi dung v√† Chuy√™n m·ª•c.");
        return;
    }

    const currentId = document.getElementById('postId').value || Date.now();
    let posts = JSON.parse(localStorage.getItem("posts") || "[]");
    let post = posts.find(p => p.id == currentId);
    
    // X·ª≠ l√Ω ·∫£nh ƒë·∫°i di·ªán
    let thumbnailBase64 = post ? post.thumbnail : '';
    if (imageFile) {
        thumbnailBase64 = await fileToBase64(imageFile);
    }

    // X·ª≠ l√Ω file t√†i li·ªáu
    let fileBase64 = post ? post.fileData : '';
    let fileName = post ? post.fileName : '';
    let fileMimeType = post ? post.fileMimeType : '';
    
    if (documentFile) {
        fileBase64 = await fileToBase64(documentFile);
        fileName = documentFile.name;
        fileMimeType = documentFile.type;
    }

    const newPost = {
        id: currentId,
        title: title,
        shortDescription: shortDescription,
        category: category,
        content: content,
        date: post ? post.date : new Date().toLocaleString('vi-VN'),
        thumbnail: thumbnailBase64,
        fileData: fileBase64,
        fileName: fileName,
        fileMimeType: fileMimeType
    };

    if (post) {
        // Ch·ªânh s·ª≠a b√†i vi·∫øt
        posts = posts.map(p => p.id == currentId ? newPost : p);
        alert("ƒê√£ c·∫≠p nh·∫≠t b√†i vi·∫øt th√†nh c√¥ng!");
    } else {
        // T·∫°o b√†i vi·∫øt m·ªõi
        posts.push(newPost);
        alert("ƒê√£ l∆∞u b√†i vi·∫øt m·ªõi th√†nh c√¥ng!");
    }

    localStorage.setItem("posts", JSON.stringify(posts));
    location.href = HOMEPAGE_URL; // Quay l·∫°i trang ch·ªß sau khi l∆∞u/c·∫≠p nh·∫≠t
}

/**
 * T·∫£i b√†i vi·∫øt v√†o form khi ch·ªânh s·ª≠a
 */
function loadPostForEdit(id) {
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    const post = posts.find(p => p.id == id);
    
    if (!post) {
        alert("B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i!");
        location.href = 'soanbai.html';
        return;
    }

    document.getElementById('postId').value = post.id;
    document.getElementById('title').value = post.title;
    document.getElementById('shortDescription').value = post.shortDescription;
    document.getElementById('category').value = post.category;
    document.getElementById('content-area').innerHTML = post.content;
    document.getElementById('saveButton').innerText = "C·∫≠p nh·∫≠t b√†i vi·∫øt";
    document.getElementById('pageTitle').innerText = "Ch·ªânh s·ª≠a b√†i vi·∫øt";
    
    // Hi·ªÉn th·ªã th√¥ng tin file ƒë√≠nh k√®m hi·ªán t·∫°i
    const fileInfoDiv = document.getElementById('currentFileInfo');
    if (post.fileName) {
        fileInfoDiv.innerHTML = `File hi·ªán t·∫°i: <strong>${post.fileName}</strong>. (Ch·ªçn file m·ªõi ƒë·ªÉ thay th·∫ø)`;
    } else {
        fileInfoDiv.innerHTML = 'Ch∆∞a c√≥ file t√†i li·ªáu ƒë√≠nh k√®m.';
    }
}

/**
 * X√≥a b√†i vi·∫øt kh·ªèi LocalStorage
 */
function deletePost(id) {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) {
        let posts = JSON.parse(localStorage.getItem("posts") || "[]");
        posts = posts.filter(p => p.id != id);
        localStorage.setItem("posts", JSON.stringify(posts));
        loadDeleteList(); // T·∫£i l·∫°i danh s√°ch sau khi x√≥a
    }
}

/**
 * T·∫£i danh s√°ch b√†i vi·∫øt ƒë·ªÉ S·ª≠a/X√≥a
 */
function loadDeleteList() {
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    const listDiv = document.getElementById("delete-list-content");
    listDiv.innerHTML = '';
    
    if (posts.length === 0) {
        listDiv.innerHTML = '<p>Kh√¥ng c√≥ b√†i vi·∫øt n√†o ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô.</p>';
        return;
    }

    posts.sort((a, b) => b.id - a.id) // B√†i m·ªõi nh·∫•t l√™n ƒë·∫ßu
          .forEach(p => {
        listDiv.innerHTML += `
            <div class="post-item">
                <span>[${p.category.toUpperCase()}] <strong>${p.title}</strong> - <small>${p.date}</small></span>
                <div>
                    <button onclick="location.href='soanbai.html?id=${p.id}'" class="edit-btn">‚úç S·ª≠a</button>
                    <button onclick="deletePost(${p.id})" class="delete-btn">üóë X√≥a</button>
                </div>
            </div>`;
    });
}


// =================================================================
// === LOGIC SAO L∆ØU V√Ä PH·ª§C H·ªíI D·ªÆ LI·ªÜU (QUAN TR·ªåNG CHO GITHUB PAGES) ===
// =================================================================

/**
 * Xu·∫•t d·ªØ li·ªáu LocalStorage th√†nh file posts_data.json
 * QUAN TR·ªåNG: File n√†y ph·∫£i ƒë∆∞·ª£c t·∫£i l√™n GitHub sau khi xu·∫•t!
 */
function backupPosts() {
    const postsJson = localStorage.getItem("posts");
    
    if (!postsJson || JSON.parse(postsJson).length === 0) {
        alert("Kh√¥ng c√≥ b√†i vi·∫øt n√†o ƒë·ªÉ sao l∆∞u.");
        return;
    }

    const postsData = JSON.parse(postsJson);
    // B·∫Øt bu·ªôc ƒë·∫∑t t√™n file l√† posts_data.json ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi code ƒë·ªçc
    const fileName = `posts_data.json`; 
    
    // T·∫°o file JSON v√† t·ª± ƒë·ªông t·∫£i xu·ªëng
    const blob = new Blob([JSON.stringify(postsData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert("ƒê√£ xu·∫•t file posts_data.json th√†nh c√¥ng! B∆Ø·ªöC CU·ªêI C√ôNG L√Ä PH·∫¢I T·∫¢I FILE N√ÄY L√äN GITHUB C·ª¶A B·∫†N!");
}

/**
 * Ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ file JSON ƒë√£ ch·ªçn v√†o LocalStorage
 */
function restorePosts() {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];

    if (!file) {
        alert("Vui l√≤ng ch·ªçn file JSON ƒë·ªÉ ph·ª•c h·ªìi.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data) && data.every(p => p.id && p.title && p.content)) {
                localStorage.setItem("posts", JSON.stringify(data));
                alert("Ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng! Trang s·∫Ω t·∫£i l·∫°i.");
                location.reload();
            } else {
                alert("C·∫•u tr√∫c file JSON kh√¥ng h·ª£p l·ªá.");
            }
        } catch (error) {
            alert("L·ªói khi x·ª≠ l√Ω n·ªôi dung file JSON.");
        }
        fileInput.value = ''; // Reset input
    };
    reader.readAsText(file);
}

// Ch·∫°y c√°c h√†m c·∫ßn thi·∫øt khi trang t·∫£i xong
window.onload = function() {
    // Ch·ªâ t·∫£i danh s√°ch s·ª≠a/x√≥a sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
    if (checkAdmin()) {
        loadDeleteList();
        if (postIdToEdit) {
            loadPostForEdit(postIdToEdit);
        }
    }
};

</script>
</head>
<body>

<h1>SO·∫†N TH·∫¢O B√ÄI VI·∫æT</h1>

<input type="hidden" id="postId" value="">

<label for="title">Ti√™u ƒë·ªÅ</label>
<input type="text" id="title">

<label for="shortDescription">M√¥ t·∫£ ng·∫Øn (Kho·∫£ng 200 k√Ω t·ª±)</label>
<input type="text" id="shortDescription">

<label for="category">Chuy√™n m·ª•c</label>
<select id="category">
    <option value="baiviet">B√†i vi·∫øt</option>
    <option value="tintuc">Tin t·ª©c & Ho·∫°t ƒë·ªông</option>
    <option value="tailieu">T√†i li·ªáu</option>
    <option value="gioithieu">Gi·ªõi thi·ªáu (√≠t d√πng)</option>
</select>

<label>N·ªôi dung</label>

<input type="file" id="contentImageFile" accept="image/*" style="display:none;">

<div id="toolbar">
  <select onchange="formatText('fontName', this.value)">
    <option value="">Ph√¥ng ch·ªØ</option>
    <option value="Arial">Arial</option>
    <option value="Verdana">Verdana</option>
    <option value="Times New Roman">Times New Roman</option>
  </select>
  
  <button onclick="formatText('justifyLeft')">CƒÉn tr√°i</button>
  <button onclick="formatText('justifyCenter')">CƒÉn gi·ªØa</button>
  <button onclick="formatText('justifyRight')">CƒÉn ph·∫£i</button>
  <button onclick="formatText('justifyFull')">CƒÉn ƒë·ªÅu</button>

  <button onclick="indentParagraph()">L√πi ƒë·∫ßu d√≤ng 1cm</button>
  
  <button onclick="insertTable()">Ch√®n B·∫£ng</button>

  <button onclick="insertImage()">Ch√®n ·∫£nh</button>
  <button onclick="insertLink()">Ch√®n Link</button>
  
  <button onclick="formatText('bold')">B</button>
  <button onclick="formatText('italic')">I</button>
  <button onclick="formatText('underline')">U</button>
</div>

<div id="content-area" contenteditable="true">
  B·∫Øt ƒë·∫ßu so·∫°n th·∫£o n·ªôi dung t·∫°i ƒë√¢y...
</div>

<div class="file-upload-section">
    <label for="image">·∫¢nh ƒë·∫°i di·ªán (S·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ - Ch·ªçn file m·ªõi ƒë·ªÉ thay th·∫ø)</label>
    <input type="file" id="image" accept="image/*">

    <label for="documentFile" style="font-weight: bold; color: #0a7f99;">T·ªáp T√†i li·ªáu (PDF, Word...) - Ch·ªâ d√†nh cho Chuy√™n m·ª•c "T√†i li·ªáu"</label>
    <div id="currentFileInfo" style="margin-bottom: 8px; font-style: italic;"></div>
    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
</div>

<button onclick="savePost()" id="saveButton">L∆∞u b√†i</button>

<button onclick="location.href = HOMEPAGE_URL">Trang ch·ªß</button>

<div id="backup-restore-section">
    <h3>Sao l∆∞u & Ph·ª•c h·ªìi D·ªØ li·ªáu</h3>
    <button onclick="backupPosts()" class="backup-btn">üíæ Xu·∫•t D·ªØ li·ªáu (Sao l∆∞u)</button>
    <input type="file" id="restoreFile" style="display:none;" accept=".json" onchange="restorePosts()">
    <button onclick="document.getElementById('restoreFile').click()" class="restore-btn">üîÑ Nh·∫≠p D·ªØ li·ªáu (Ph·ª•c h·ªìi)</button>
    <p style="font-size: 12px; color: red; margin-top: 10px;">L∆ØU √ù: N·∫øu b·∫°n mu·ªën b√†i vi·∫øt xu·∫•t hi·ªán c√¥ng khai tr√™n Internet, b·∫°n B·∫ÆT BU·ªòC ph·∫£i t·∫£i file **posts_data.json** (v·ª´a xu·∫•t) l√™n GitHub sau khi ho√†n th√†nh m·ªçi ch·ªânh s·ª≠a.</p>
</div>

<div id="delete-list">
    <h2>Danh s√°ch B√†i vi·∫øt ƒë√£ L∆∞u C·ª•c B·ªô</h2>
    <div id="delete-list-content">
        <p>ƒêang t·∫£i danh s√°ch...</p>
    </div>
</div>

</body>
</html>