<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title id="pageTitle">H·ªá th·ªëng So·∫°n th·∫£o & Qu·∫£n l√Ω B√†i vi·∫øt</title>
<style>
/* CSS ƒê·∫ßy ƒë·ªß v√† T·ªëi ∆∞u */
body {font-family: Arial, sans-serif; max-width: 1000px; margin: auto; padding: 20px; background-color: #f4f7f8;}
h1 {color: #0a7f99; text-align: center; margin-bottom: 5px;}
#storage-status {text-align: center; font-size: 13px; color: #666; margin-bottom: 20px;}
label {display: block; font-weight: bold; margin-top: 15px;}
select, input[type="text"] {width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
#toolbar {margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center;} 
#toolbar button, #toolbar select {padding: 6px 12px; cursor: pointer; border: 1px solid #aaa; background: #fff; border-radius: 3px; font-size: 13px;}
#content-area {border: 1px solid #ccc; padding: 15px; min-height: 400px; margin-top: 5px; background: #fff; line-height: 1.6; text-align: justify; overflow-y: auto; border-radius: 4px;}
button {padding: 10px 20px; margin-top: 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s;}

/* M√†u s·∫Øc c√°c n√∫t */
#saveButton {background: #2ecc71; color: white;}
#saveButton:hover {background: #27ae60;}
.home-btn {background: #3498db; color: white;}
.btn-github {background: #2c3e50 !important; color: white !important;}
.btn-backup {background: #9b59b6; color: white;}
.btn-restore {background: #34495e; color: white;}
.btn-clear {background: #e67e22; color: white;}

#delete-list {margin-top: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #fff;}
.post-item {display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee;}
.edit-btn {background: #f39c12; color: white; padding: 5px 10px; font-size: 12px;}
.delete-btn {background: #e74c3c; color: white; padding: 5px 10px; font-size: 12px;}
.file-section {background: #f9f9f9; padding: 15px; border: 1px solid #eee; margin-top: 15px; border-radius: 4px;}
</style>
</head>
<body>

<h1>H·ªÜ TH·ªêNG SO·∫†N TH·∫¢O B√ÄI VI·∫æT</h1>
<div id="storage-status">ƒêang ki·ªÉm tra b·ªô nh·ªõ...</div>

<input type="hidden" id="postId" value="">

<label>Ti√™u ƒë·ªÅ b√†i vi·∫øt</label>
<input type="text" id="title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">

<label>M√¥ t·∫£ ng·∫Øn (Hi·ªán ·ªü trang ch·ªß)</label>
<input type="text" id="shortDescription" placeholder="T√≥m t·∫Øt ng·∫Øn g·ªçn n·ªôi dung b√†i vi·∫øt...">

<label>Chuy√™n m·ª•c</label>
<select id="category">
    <option value="baiviet">B√†i vi·∫øt</option>
    <option value="tintuc">Tin t·ª©c & Ho·∫°t ƒë·ªông</option>
    <option value="tailieu">T√†i li·ªáu</option>
    <option value="gioithieu">Gi·ªõi thi·ªáu</option>
</select>

<label>N·ªôi dung chi ti·∫øt</label>
<div id="toolbar">
  <button onclick="formatText('bold')"><b>B</b></button>
  <button onclick="formatText('italic')"><i>I</i></button>
  <button onclick="formatText('underline')"><u>U</u></button>
  <button onclick="formatText('justifyLeft')">Tr√°i</button>
  <button onclick="formatText('justifyCenter')">Gi·ªØa</button>
  <button onclick="formatText('justifyFull')">ƒê·ªÅu</button>
  <button onclick="indentFirstLine()">T·ª•t ƒë·∫ßu d√≤ng 1cm</button>
  <button onclick="insertTable()">Ch√®n B·∫£ng</button>
  <button onclick="insertGitHubImage()" class="btn-github">üñºÔ∏è Ch√®n ·∫£nh GitHub/URL (Khuy√™n d√πng)</button>
  <button onclick="insertLocalImage()">üì∑ Ch√®n ·∫£nh t·ª´ m√°y (D·ªÖ ƒë·∫ßy b·ªô nh·ªõ)</button>
  <button onclick="insertLink()">Ch√®n Link</button>
</div>

<div id="content-area" contenteditable="true">B·∫Øt ƒë·∫ßu so·∫°n th·∫£o...</div>
<input type="file" id="localImgInput" accept="image/*" style="display:none;">

<div class="file-section">
    <label style="color: #c0392b;">URL ·∫¢nh ƒê·∫°i Di·ªán (N√™n d√πng Link GitHub)</label>
    <input type="text" id="thumbnailUrl" placeholder="V√≠ d·ª•: https://raw.githubusercontent.com/...">
    
    <label style="margin-top: 15px;">Ho·∫∑c T·∫£i ·∫£nh ƒë·∫°i di·ªán t·ª´ m√°y (N·∫øu ·∫£nh nh·∫π)</label>
    <input type="file" id="imageFile" accept="image/*">

    <label style="color: #0a7f99; margin-top: 15px;">T·ªáp ƒë√≠nh k√®m (PDF, Word...)</label>
    <div id="currentFileInfo" style="font-size: 12px; color: blue; margin-bottom: 5px;"></div>
    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.xls,.xlsx">
</div>

<button onclick="savePost()" id="saveButton">L∆∞u b√†i vi·∫øt</button>
<button onclick="location.href='index.html'" class="home-btn">Quay l·∫°i Trang ch·ªß</button>

<div id="backup-restore-section" style="margin-top: 30px; padding: 20px; border: 2px solid #0a7f99; border-radius: 8px; background: #e7f5fa;">
    <h3>Qu·∫£n l√Ω & Xu·∫•t d·ªØ li·ªáu ( posts_data.json )</h3>
    <button onclick="backupPosts()" class="btn-backup">üíæ Xu·∫•t file JSON (L·∫•y b√†i vi·∫øt m·ªõi)</button>
    <input type="file" id="restoreFile" style="display:none;" accept=".json" onchange="restorePosts()">
    <button onclick="document.getElementById('restoreFile').click()" class="btn-restore">üîÑ Nh·∫≠p file JSON (S·ª≠a b√†i c≈©)</button>
    <button onclick="clearAllData()" class="btn-clear">üóëÔ∏è X√≥a s·∫°ch b·ªô nh·ªõ t·∫°m</button>
</div>

<div id="delete-list">
    <h2>Danh s√°ch b√†i vi·∫øt trong b·ªô nh·ªõ t·∫°m</h2>
    <div id="delete-list-content"></div>
</div>

<script>
// 1. Ki·ªÉm tra m·∫≠t kh·∫©u
if (sessionStorage.getItem('isAdmin') !== 'true') {
    if (prompt("Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã:") === "123") sessionStorage.setItem('isAdmin', 'true');
    else location.href = "index.html";
}

// 2. C√°c h√†m so·∫°n th·∫£o
function formatText(cmd, val = null) { document.execCommand(cmd, false, val); document.getElementById('content-area').focus(); }

function indentFirstLine() {
    document.execCommand('formatBlock', false, 'p');
    const selection = window.getSelection();
    let node = selection.getRangeAt(0).startContainer;
    if (node.nodeType === 3) node = node.parentNode;
    node.style.textIndent = "1cm";
}

function insertGitHubImage() {
    let url = prompt("D√°n link ·∫£nh GitHub (Link Raw):");
    if (url) {
        if (url.includes("github.com") && !url.includes("raw.githubusercontent.com")) {
            url = url.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }
        document.execCommand('insertHTML', false, `<img src="${url}" style="max-width:100%; display:block; margin:10px auto;">`);
    }
}

function insertLocalImage() {
    const input = document.getElementById('localImgInput');
    input.click();
    input.onchange = e => {
        const file = e.target.files[0];
        if (file && file.size > 500000) alert("C·∫£nh b√°o: ·∫¢nh l·ªõn d·ªÖ g√¢y l·ªói kh√¥ng l∆∞u ƒë∆∞·ª£c!");
        const reader = new FileReader();
        reader.onload = ev => document.execCommand('insertHTML', false, `<img src="${ev.target.result}" style="max-width:100%;">`);
        reader.readAsDataURL(file);
    };
}

function insertTable() {
    const r = prompt("S·ªë h√†ng:", 3), c = prompt("S·ªë c·ªôt:", 3);
    if (r && c) {
        let html = '<table border="1" style="width:100%; border-collapse: collapse; margin: 10px 0;">';
        for (let i = 0; i < r; i++) {
            html += '<tr>';
            for (let j = 0; j < c; j++) html += '<td style="padding: 8px; border: 1px solid #ccc;">N·ªôi dung</td>';
            html += '</tr>';
        }
        document.execCommand('insertHTML', false, html + '</table>');
    }
}

function insertLink() { const url = prompt("Nh·∫≠p URL:"); if (url) document.execCommand('createLink', false, url); }

function fileToBase64(file) {
    return new Promise((resolve) => {
        if (!file) resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });
}

// 3. H√†m L∆∞u & Qu·∫£n l√Ω d·ªØ li·ªáu
async function savePost() {
    const id = document.getElementById('postId').value || Date.now().toString();
    const title = document.getElementById('title').value;
    const contentHtml = document.getElementById('content-area').innerHTML;
    
    if (!title || contentHtml === "B·∫Øt ƒë·∫ßu so·∫°n th·∫£o...") { alert("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† n·ªôi dung!"); return; }

    let posts = JSON.parse(localStorage.getItem("posts") || "[]");
    let oldPost = posts.find(p => String(p.id) === String(id));

    // X·ª≠ l√Ω ·∫£nh ƒë·∫°i di·ªán
    let thumb = document.getElementById('thumbnailUrl').value;
    const thumbFile = document.getElementById('imageFile').files[0];
    if (!thumb && thumbFile) thumb = await fileToBase64(thumbFile);
    else if (!thumb && oldPost) thumb = oldPost.thumbnail;

    // X·ª≠ l√Ω t·ªáp ƒë√≠nh k√®m
    const docFile = document.getElementById('documentFile').files[0];
    let fData = oldPost ? oldPost.fileData : '';
    let fName = oldPost ? oldPost.fileName : '';
    if (docFile) {
        fData = await fileToBase64(docFile);
        fName = docFile.name;
    }

    const newPost = {
        id: id,
        title: title,
        category: document.getElementById('category').value,
        description: contentHtml,
        shortDescription: document.getElementById('shortDescription').value || (document.getElementById('content-area').innerText.substring(0, 150) + "..."),
        date: oldPost ? oldPost.date : new Date().toISOString().slice(0, 10),
        author: "Admin",
        thumbnail: thumb,
        fileData: fData,
        fileName: fName,
        likes: oldPost ? oldPost.likes : 0
    };

    const index = posts.findIndex(p => String(p.id) === String(id));
    if (index > -1) posts[index] = newPost; else posts.push(newPost);

    try {
        localStorage.setItem("posts", JSON.stringify(posts));
        alert("L∆∞u t·∫°m th√†nh c√¥ng! ƒê·ª´ng qu√™n 'Xu·∫•t file JSON' ƒë·ªÉ c·∫≠p nh·∫≠t web.");
        loadDeleteList();
    } catch (e) {
        alert("L·ªñI: B·ªô nh·ªõ ƒë·∫ßy! Vui l√≤ng x√≥a b·ªõt b√†i c≈© ho·∫∑c d√πng link ·∫£nh GitHub.");
    }
}

function loadDeleteList() {
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    const used = (JSON.stringify(localStorage).length / 1024 / 1024).toFixed(2);
    document.getElementById('storage-status').innerText = `B·ªô nh·ªõ ƒë√£ d√πng: ${used}MB / Gi·ªõi h·∫°n ~5MB`;
    
    document.getElementById('delete-list-content').innerHTML = posts.sort((a,b) => b.id - a.id).map(p => `
        <div class="post-item">
            <span>[${p.category}] ${p.title}</span>
            <div>
                <button class="edit-btn" onclick="loadPostForEdit('${p.id}')">S·ª≠a</button>
                <button class="delete-btn" onclick="deletePost('${p.id}')">X√≥a</button>
            </div>
        </div>
    `).join('');
}

function loadPostForEdit(id) {
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    const p = posts.find(x => String(x.id) === String(id));
    if (!p) return;

    document.getElementById('postId').value = p.id;
    document.getElementById('title').value = p.title;
    document.getElementById('shortDescription').value = p.shortDescription;
    document.getElementById('category').value = p.category;
    document.getElementById('content-area').innerHTML = p.description;
    if (p.thumbnail && !p.thumbnail.startsWith('data:')) document.getElementById('thumbnailUrl').value = p.thumbnail;
    if (p.fileName) document.getElementById('currentFileInfo').innerText = "ƒê√£ c√≥ t·ªáp: " + p.fileName;
    document.getElementById('saveButton').innerText = "C·∫≠p nh·∫≠t b√†i vi·∫øt";
    window.scrollTo(0,0);
}

function deletePost(id) {
    if (confirm("X√≥a b√†i n√†y kh·ªèi b·ªô nh·ªõ t·∫°m?")) {
        let posts = JSON.parse(localStorage.getItem("posts") || "[]");
        localStorage.setItem("posts", JSON.stringify(posts.filter(p => String(p.id) !== String(id))));
        loadDeleteList();
    }
}

function backupPosts() {
    const data = localStorage.getItem("posts") || "[]";
    const blob = new Blob([data], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "posts_data.json";
    a.click();
}

function restorePosts() {
    const file = document.getElementById('restoreFile').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            localStorage.setItem("posts", e.target.result);
            alert("ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!");
            loadDeleteList();
        };
        reader.readAsText(file);
    }
}

function clearAllData() {
    if(confirm("C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y x√≥a s·∫°ch b·ªô nh·ªõ t·∫°m tr√¨nh duy·ªát. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ nh·∫•n 'Xu·∫•t file JSON' ƒë·ªÉ l∆∞u l·∫°i file d·ªØ li·ªáu.")) {
        localStorage.removeItem("posts");
        location.reload();
    }
}

window.onload = () => {
    loadDeleteList();
    const id = new URLSearchParams(window.location.search).get('id');
    if (id) loadPostForEdit(id);
};
</script>
</body>
</html>