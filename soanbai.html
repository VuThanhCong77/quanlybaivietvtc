<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title id="pageTitle">So·∫°n th·∫£o b√†i vi·∫øt</title>
<style>
/* CSS GI·ªÆ NGUY√äN THEO B·∫¢N G·ªêC C·ª¶A B·∫†N */
body {font-family: Arial; max-width: 900px; margin: auto; padding: 20px; background-color: #f4f7f8;}
h1 {color: #0a7f99; text-align: center;}
label {display: block; font-weight: bold; margin-top: 15px;}
select, input[type="text"] {width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; box-sizing: border-box; border-radius: 4px;}
#toolbar {margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 4px; display: flex; flex-wrap: wrap; align-items: center;} 
#toolbar button, #toolbar select {padding: 5px 10px; margin: 3px; cursor: pointer; border: 1px solid #aaa; background: #fff; border-radius: 3px;}
#content-area {border: 1px solid #ccc; padding: 15px; min-height: 350px; margin-top: 5px; background: #fff; line-height: 1.6; text-align: justify; max-height: 600px; overflow-y: auto; border-radius: 4px;}
button {padding: 10px 15px; margin-top: 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: background 0.3s;}
#saveButton {background: #2ecc71; color: white;} 
.home-btn {background: #3498db; color: white;}
#delete-list {margin-top: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #fff;}
.post-item {display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee;}
.edit-btn {background: #f39c12; color: white;}
.delete-btn {background: #e74c3c; color: white;}
.file-upload-section {margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 4px; background: #f9f9f9;}
#backup-restore-section {margin-top: 30px; padding: 20px; border: 2px solid #0a7f99; border-radius: 8px; background: #e7f5fa;}
.backup-btn {background: #9b59b6; color: white;}
.restore-btn {background: #34495e; color: white;}
.warning-share {color: #c0392b; font-size: 13px; margin: 10px 0; padding: 10px; border: 1px solid #f9caca; background-color: #fff0f0; border-radius: 4px;}
</style>
</head>
<body>

<h1>SO·∫†N TH·∫¢O B√ÄI VI·∫æT</h1>

<input type="hidden" id="postId" value="">

<label for="title">Ti√™u ƒë·ªÅ</label>
<input type="text" id="title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt...">

<label for="shortDescription">M√¥ t·∫£ ng·∫Øn (Hi·ªÉn th·ªã ·ªü danh s√°ch b√†i vi·∫øt)</label>
<input type="text" id="shortDescription" placeholder="T√≥m t·∫Øt ng·∫Øn g·ªçn n·ªôi dung...">

<label for="category">Chuy√™n m·ª•c</label>
<select id="category">
    <option value="baiviet">B√†i vi·∫øt</option>
    <option value="tintuc">Tin t·ª©c & Ho·∫°t ƒë·ªông</option>
    <option value="tailieu">T√†i li·ªáu</option>
    <option value="gioithieu">Gi·ªõi thi·ªáu</option>
</select>

<label>N·ªôi dung chi ti·∫øt</label>
<div id="toolbar">
  <select onchange="formatText('fontName', this.value)">
    <option value="">Ph√¥ng ch·ªØ</option>
    <option value="Arial">Arial</option>
    <option value="Times New Roman">Times New Roman</option>
  </select>
  <select onchange="formatText('fontSize', this.value)">
    <option value="">C·ª° ch·ªØ</option>
    <option value="3">V·ª´a (12pt)</option>
    <option value="4">L·ªõn (14pt)</option>
    <option value="5">R·∫•t l·ªõn (18pt)</option>
  </select>
  <button onclick="formatText('bold')"><b>B</b></button>
  <button onclick="formatText('italic')"><i>I</i></button>
  <button onclick="formatText('underline')"><u>U</u></button>
  <button onclick="formatText('justifyLeft')">Tr√°i</button>
  <button onclick="formatText('justifyCenter')">Gi·ªØa</button>
  <button onclick="formatText('justifyFull')">ƒê·ªÅu</button>
  <button onclick="indentFirstLine()">T·ª•t ƒë·∫ßu d√≤ng 1cm</button>
  <button onclick="insertTable()">Ch√®n B·∫£ng</button>
  <button onclick="insertImage()">Ch√®n ·∫£nh</button>
  <button onclick="insertLink()">Ch√®n Link</button>
</div>

<div id="content-area" contenteditable="true">B·∫Øt ƒë·∫ßu so·∫°n th·∫£o...</div>

<input type="file" id="contentImageFile" accept="image/*" style="display:none;">

<div class="file-upload-section">
    <label for="thumbnailUrl" style="color: #c0392b;">URL ·∫¢nh ƒê·∫°i Di·ªán (D√†nh cho hi·ªÉn th·ªã b√†i vi·∫øt)</label>
    <input type="text" id="thumbnailUrl" placeholder="V√≠ d·ª•: images/photo.jpg">
    <div class="warning-share">
        ‚ö†Ô∏è <b>L∆ØU √ù:</b> N√™n d√πng URL ·∫£nh ƒë·ªÉ chia s·∫ª m·∫°ng x√£ h·ªôi ƒë·∫πp h∆°n.
    </div>
    <label>Ho·∫∑c T·∫£i file ·∫£nh ƒë·∫°i di·ªán</label>
    <input type="file" id="image" accept="image/*">
    
    <label style="color: #0a7f99; margin-top: 25px;">T·ªáp T√†i li·ªáu (PDF, Word...)</label>
    <div id="currentFileInfo" style="margin-bottom: 8px; font-style: italic; font-size: 0.9em;"></div>
    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
</div>

<button onclick="savePost()" id="saveButton">L∆∞u b√†i vi·∫øt</button>
<button onclick="location.href='index.html'" class="home-btn">Quay l·∫°i Trang ch·ªß</button>

<div id="backup-restore-section">
    <h3>Qu·∫£n l√Ω D·ªØ li·ªáu H·ªá th·ªëng</h3>
    <button onclick="backupPosts()" class="backup-btn">üíæ Xu·∫•t file JSON (ƒê·ªÉ c·∫≠p nh·∫≠t Website)</button>
    <input type="file" id="restoreFile" style="display:none;" accept=".json" onchange="restorePosts()">
    <button onclick="document.getElementById('restoreFile').click()" class="restore-btn">üîÑ Nh·∫≠p file JSON (ƒê·ªÉ s·ª≠a ti·∫øp)</button>
    <p style="font-size: 12px; color: red; margin-top: 10px;">* Sau khi L∆∞u, nh·∫•n "Xu·∫•t file JSON" v√† ƒë·ªïi t√™n th√†nh <b>posts_data.json</b> ƒë·ªÉ t·∫£i l√™n host.</p>
</div>

<div id="delete-list">
    <h2>Danh s√°ch b√†i vi·∫øt ƒë√£ l∆∞u t·∫°m</h2>
    <div id="delete-list-content">ƒêang t·∫£i...</div>
</div>

<script>
const ADMIN_PASSWORD = "Cong&khuyen7785";
const HOMEPAGE_URL = "index.html";

function checkAdmin() { return sessionStorage.getItem('isAdmin') === 'true'; }
if (!checkAdmin()) {
    const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã:");
    if (pass === ADMIN_PASSWORD) {
        sessionStorage.setItem('isAdmin', 'true');
        location.reload();
    } else {
        location.href = HOMEPAGE_URL;
    }
}

function formatText(cmd, val = null) {
    document.execCommand(cmd, false, val);
    document.getElementById('content-area').focus();
}

function indentFirstLine() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    let node = selection.getRangeAt(0).startContainer;
    if (node.nodeType === 3) node = node.parentNode;
    let block = node;
    while(block && block.id !== 'content-area' && block.nodeType === 1) {
        if (block.tagName === 'P' || block.tagName === 'DIV') break;
        block = block.parentNode;
    }
    if (block && block.id !== 'content-area') {
        block.style.textIndent = block.style.textIndent === '1cm' ? '0' : '1cm';
    }
}

function insertTable() {
    const r = prompt("S·ªë h√†ng:", 3), c = prompt("S·ªë c·ªôt:", 3);
    if (r && c) {
        let html = '<table border="1" style="width:100%; border-collapse: collapse; margin: 10px 0;">';
        for (let i = 0; i < r; i++) {
            html += '<tr>';
            for (let j = 0; j < c; j++) html += '<td style="padding: 8px; border: 1px solid #ccc;">N·ªôi dung</td>';
            html += '</tr>';
        }
        document.execCommand('insertHTML', false, html + '</table>');
    }
}

function insertImage() {
    const input = document.getElementById('contentImageFile');
    input.click();
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.execCommand('insertHTML', false, `<img src="${ev.target.result}" style="max-width:100%; display:block; margin: 10px auto;">`);
            };
            reader.readAsDataURL(file);
        }
    };
}

function insertLink() {
    const url = prompt("Nh·∫≠p URL:");
    if (url) document.execCommand('createLink', false, url);
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// H√ÄM L∆ØU CH√çNH - ƒê√É ƒê·ªíNG B·ªò TR∆Ø·ªúNG DESCRIPTION
async function savePost() {
    const id = document.getElementById('postId').value || Date.now().toString();
    const title = document.getElementById('title').value;
    const shortDesc = document.getElementById('shortDescription').value;
    const category = document.getElementById('category').value;
    const contentHtml = document.getElementById('content-area').innerHTML;
    const thumbUrl = document.getElementById('thumbnailUrl').value;
    const imgFile = document.getElementById('image').files[0];
    const docFile = document.getElementById('documentFile').files[0];

    if (!title || !contentHtml || contentHtml === "B·∫Øt ƒë·∫ßu so·∫°n th·∫£o...") { 
        alert("Thi·∫øu ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung!"); 
        return; 
    }

    let posts = JSON.parse(localStorage.getItem("posts") || "[]");
    let oldPost = posts.find(p => String(p.id) === String(id));

    let finalThumb = oldPost ? oldPost.thumbnail : '';
    if (thumbUrl) finalThumb = thumbUrl;
    else if (imgFile) finalThumb = await fileToBase64(imgFile);

    let fileB64 = oldPost ? oldPost.fileData : '';
    let fName = oldPost ? oldPost.fileName : '';
    let fMime = oldPost ? oldPost.fileMimeType : '';

    if (docFile) {
        fileB64 = await fileToBase64(docFile);
        fName = docFile.name;
        fMime = docFile.type;
    }

    const newPost = {
        id: id,
        title: title,
        category: category,
        description: contentHtml, // ƒê·ªìng b·ªô v·ªõi trang chi ti·∫øt
        shortDescription: shortDesc || (document.getElementById('content-area').innerText.substring(0, 150) + "..."),
        date: oldPost ? oldPost.date : new Date().toISOString().slice(0, 10),
        author: "Admin", // M·∫∑c ƒë·ªãnh l√† Admin
        thumbnail: finalThumb,
        fileData: fileB64, 
        fileName: fName, 
        fileMimeType: fMime,
        likes: oldPost ? oldPost.likes : 0,
        dislikes: oldPost ? oldPost.dislikes : 0
    };

    if (oldPost) posts = posts.map(p => String(p.id) === String(id) ? newPost : p);
    else posts.push(newPost);

    localStorage.setItem("posts", JSON.stringify(posts));
    alert("ƒê√£ l∆∞u th√†nh c√¥ng v√†o b·ªô nh·ªõ tr√¨nh duy·ªát! H√£y nh·∫•n 'Xu·∫•t file JSON' ƒë·ªÉ c·∫≠p nh·∫≠t web.");
    loadDeleteList();
}

function loadPostForEdit(id) {
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    const p = posts.find(x => String(x.id) === String(id));
    if (!p) return;

    document.getElementById('postId').value = p.id;
    document.getElementById('title').value = p.title;
    document.getElementById('shortDescription').value = p.shortDescription;
    document.getElementById('category').value = p.category;
    document.getElementById('content-area').innerHTML = p.description || p.content;
    if (p.thumbnail && !p.thumbnail.startsWith('data:')) document.getElementById('thumbnailUrl').value = p.thumbnail;
    if (p.fileName) document.getElementById('currentFileInfo').innerText = "T·ªáp ƒë√≠nh k√®m hi·ªán t·∫°i: " + p.fileName;
    document.getElementById('saveButton').innerText = "C·∫≠p nh·∫≠t b√†i vi·∫øt";
}

function loadDeleteList() {
    const posts = JSON.parse(localStorage.getItem("posts") || "[]");
    const container = document.getElementById("delete-list-content");
    container.innerHTML = posts.length ? "" : "Ch∆∞a c√≥ b√†i vi·∫øt n√†o.";
    posts.sort((a,b) => b.id - a.id).forEach(p => {
        container.innerHTML += `
            <div class="post-item">
                <span>[${p.category}] ${p.title}</span>
                <div>
                    <button class="edit-btn" onclick="location.href='soanbai.html?id=${p.id}'">S·ª≠a</button>
                    <button class="delete-btn" onclick="deletePost('${p.id}')">X√≥a</button>
                </div>
            </div>`;
    });
}

function deletePost(id) {
    if (confirm("X√≥a b√†i n√†y kh·ªèi danh s√°ch t·∫°m?")) {
        let posts = JSON.parse(localStorage.getItem("posts") || "[]");
        localStorage.setItem("posts", JSON.stringify(posts.filter(p => String(p.id) !== String(id))));
        loadDeleteList();
    }
}

function backupPosts() {
    const data = localStorage.getItem("posts") || "[]";
    const blob = new Blob([data], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "posts_data.json";
    a.click();
}

function restorePosts() {
    const file = document.getElementById('restoreFile').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            localStorage.setItem("posts", e.target.result);
            alert("ƒê√£ ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ file JSON!");
            location.reload();
        };
        reader.readAsText(file);
    }
}

window.onload = () => {
    loadDeleteList();
    const id = new URLSearchParams(window.location.search).get('id');
    if (id) loadPostForEdit(id);
};
</script>
</body>

</html>
